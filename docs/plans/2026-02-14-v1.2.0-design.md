# ConKeeper v1.2.0 Design — Session Intelligence

**Status:** Approved | **Date:** 2026-02-14 | **Version:** 1.2.0

## Overview

Five features integrated into existing touch points. All features are automatic — no new slash commands required for basic operation.

| Feature | Delivery | Touch Points |
|---|---|---|
| Memory Health Scoring | `session-start.sh` + `stop.sh` | Commit-based staleness, directive advisory |
| Cross-Project Search | `tools/memory-search.sh` + init/config skills | `--cross-project` flag, explicit config |
| Friction-Aware Session Start | `/memory-insights` SKILL.md | One-way write to friction.md, loaded at start |
| Memory Diff on Resume | `session-start.sh` | Changed memory files + git oneline since last sync |
| Decision Index | `/memory-sync` SKILL.md + `session-start.sh` | Generated INDEX.md with agent lookup instructions |

### Design Principles

- All bash targets **bash 3.2** (macOS default)
- Hook additions target **<2s total**, graceful skip on timeout via `date +%s` elapsed measurement
- No new dependencies beyond existing optional `jq` and `git`
- **Hooks never prompt interactively** — all configuration lives in `/memory-init` or `/memory-config`
- **Advisories are directive** — tell agents what to DO, not just what changed
- **Token budget gating** — economy preset suppresses friction.md, INDEX.md, and diff output; only health scoring (~70 tokens) is always present
- **Single stop-hook message** — one consolidated suggestion at session end, never multiple competing suggestions
- `.last-sync` location: `.claude/memory/.last-sync`, written by `/memory-sync` only (manual and auto-sync)
- **Each component degrades independently** — if a skill in the chain isn't invoked, the others still work

---

## Feature 1: Memory Health Scoring

Silent when healthy. Directive advisory when stale.

### session-start.sh

After existing directory validation and context building:

1. Check for `.claude/memory/.last-sync`
   - If missing (first run or upgrade from v1.1.0): write current timestamp (`date +%s`) to `.last-sync` and skip health scoring this session. No false "everything stale" on first use.
2. Read `staleness_commits` from `.memory-config.md` (default: 5). Value of 0 disables the health check.
3. For each file in `[active-context.md, progress.md, patterns.md, glossary.md, product-context.md, friction.md]`:
   - Get file mtime via `stat -f %m` (BSD-compatible)
   - Count commits since: `git rev-list --count --after="@<mtime>" HEAD -- .`
   - If count > threshold → add to stale list
4. Performance guard: `date +%s` before and after the git block. If elapsed > 1s, skip remaining files and cache partial results.
5. Cache results to `$TMPDIR/conkeeper/health-<date>` so the stop hook reads cached results without re-running git.
6. If stale list is non-empty, append to `additionalContext`:

```
<conkeeper-health>
Stale memory (>{N} commits since last update):
  - patterns.md (12 commits behind)
  - glossary.md (8 commits behind)
Before proceeding with the user's task, run /memory-sync to refresh stale memory files.
</conkeeper-health>
```

7. If all files are current → output nothing.

### stop.sh

Before existing `/memory-reflect` trigger:

1. Read cached health results from `$TMPDIR/conkeeper/health-<date>`.
2. Check if `.last-sync` mtime is newer than session start (sync happened this session).
3. If stale files exist AND no sync happened → single consolidated message:

```
Session ending with stale memory. Run /memory-sync to preserve context (this will also trigger /memory-reflect if corrections were processed).
```

4. If sync already happened → no message.
5. If no stale files → existing reflect suggestion unchanged.

### Config

```yaml
staleness_commits: 5    # default; 0 = disable
```

Added to `/memory-config` skill documentation and defaults.

### Known Limitations

- Commit counting with mtime is fragile across rebases/force-pushes (hashes change, mtimes don't). Acceptable for advisory-only feature. Documented in schema.md.
- Commit-only metric (no calendar component). A hybrid metric (commits + days) is a candidate for v1.3.0 after observing real usage.

---

## Feature 2: Cross-Project Search

Extends `tools/memory-search.sh` with `--cross-project` flag. Requires explicit configuration. No defaults. No prompts from hooks.

### Configuration

`.memory-config.md`:
```yaml
project_search_paths: ["~/zed", "~/work"]   # explicit paths
# OR
project_search_paths: disabled               # permanently off
# OR (absent) — feature off, prompted only at /memory-init and /memory-config
```

Three states:
- **Absent** → feature off. Prompted at `/memory-init` and `/memory-config` only. Hooks stay silent.
- **Paths set** → `--cross-project` flag active.
- **`disabled`** → feature off, no prompts anywhere.

### Prompt UX (skills only, never hooks)

**`/memory-init` (Step 4.5):** After token budget selection:

> Enable cross-project memory search? [y/n]

If yes → ask for paths (comma-separated), write to config.
If no → "Disable this prompt permanently? [y/n]"
- If yes → set `project_search_paths: disabled`
- If no → leave absent (prompted again at next init or config)

**`/memory-config`:** Shows `project_search_paths` as configurable when absent or set.

### tools/memory-search.sh

1. Parse `--cross-project` flag.
2. Read `project_search_paths` from `.claude/memory/.memory-config.md`.
3. If not configured or `disabled` → output: `"Cross-project search not configured. Run /memory-config to set project_search_paths. Example: project_search_paths: [\"~/zed\", \"~/work\"]"`
4. If configured → expand `~` → `$HOME`, then for each path:
   - **Validate:** `validate_memory_dir()` pattern — check symlinks, ensure resolved path doesn't escape the configured parent directory. Refuse paths that resolve outside.
   - Find `*/.claude/memory/` directories.
   - Exclude the current project (already searched by default).
5. Run existing search logic against each discovered directory.
6. Prefix results with project name: `[context-keeper] patterns.md:12 — "bash 3.2 (macOS default)"`
7. Respect `<private>` tags in all searched directories using existing `lib-privacy.sh`.

### Flag Stacking

All existing flags compose with `--cross-project`:
```
/memory-search --cross-project --category decision "auth"
/memory-search --cross-project --global "bash portability"
/memory-search --cross-project --sessions "authentication bug"
```

### Multi-Platform

Platform skill descriptions (Copilot, Cursor, Codex, Windsurf, Zed) updated to document `--cross-project`. The underlying shell script is already cross-platform.

---

## Feature 3: Friction-Aware Session Start

`/memory-insights` routes high-friction findings into a dedicated `friction.md`. Session-start loads it automatically. `/memory-reflect` cross-references it during retrospection. Each component works independently — no multi-skill coordination required.

### v1.2.0 Scope

- `/memory-insights` analyzes facets, proposes writing findings to `friction.md` (one-way, regenerates on each run)
- Session-start loads `friction.md` as part of normal memory context injection
- `/memory-reflect` reads `friction.md` during AAR, notes if known patterns were triggered
- No automatic lifecycle management (New/Repeat/Resolved state machine deferred to v1.3.0)
- Max ~15-20 entries. When `/memory-insights` regenerates, it keeps top entries by recurrence frequency, drops the rest

### New File: `.claude/memory/friction.md`

```markdown
# Friction Patterns
<!-- Generated by /memory-insights. Edit freely. -->
<!-- Loaded at session start to help agents avoid known pitfalls. -->
<!-- Max ~15-20 entries to stay within token budget. -->

## Conventions
- When debugging, verify root cause hypothesis before attempting fixes. Stop after 2 failed attempts and reassess.
  <!-- @category: pattern -->
- Docker volume permissions cannot be fixed from inside the container. Verify mount-layer assumptions first.
  <!-- @category: convention -->

## Project-Specific
<!-- Friction patterns specific to this project -->
```

Created by `/memory-init` (Step 3, alongside other files).

### `/memory-insights` SKILL.md — Insight Routing

After presenting analysis results:

```
### Insight Routing

After analysis, check if findings represent actionable conventions.

Examples:
- "Debugging tasks have 100% friction rate" → friction.md convention
- "Docker/container tasks fail consistently" → friction.md convention
- "Iterative refinement sessions spiral after 3 attempts" → friction.md convention

Present proposed additions:

> Insights suggest adding to friction.md:
>   - "When debugging, verify hypothesis before fix attempts (2-strike limit)"
>     <!-- @category: pattern -->
> Route to friction.md? [y/n]

On approval, write to friction.md. Cap total entries at ~15-20.
If file exceeds cap, drop least-recurrent entries.
```

### `/memory-reflect` SKILL.md — Friction Cross-Reference

During AAR analysis:

```
### Friction Pattern Check

If .claude/memory/friction.md exists:
1. Read friction.md conventions
2. Check if this session triggered any known friction patterns
3. If yes: "Known friction pattern triggered: [convention].
   Was the convention followed? If not, consider stronger wording
   or more prominent placement."
4. If a convention was followed and friction was avoided: note as positive signal
```

### Token Budget Gating

| Preset | friction.md behavior |
|---|---|
| Economy (~2000) | Not loaded |
| Light (~3000) | Loaded, capped at ~200 tokens |
| Standard (~4000) | Loaded, capped at ~400 tokens |
| Detailed (~6000) | Loaded, full content |

### Degradation

- `/memory-insights` never runs → friction.md empty or absent. No harm.
- `/memory-reflect` never runs → friction patterns still loaded at start, just no feedback. Fine.
- Each piece works on its own.

---

## Feature 4: Memory Diff on Resume

On session start, show what changed since last sync. Silent when nothing changed.

### `.last-sync` Marker

- **Location:** `.claude/memory/.last-sync`
- **Format:** Single line, unix epoch timestamp
- **Written by:** `/memory-sync` skill (Step 4.5) — manual and auto-sync modes
- **Read by:** `session-start.sh` — reads epoch from file content (not mtime, which is fragile to backup tools and file sync)
- **Security:** Refuse to read or write through symlinks
- **First-run:** Created by Feature 1's first-run logic with current timestamp

### `/memory-sync` SKILL.md (Step 4.5)

After applying updates (Step 4):

```
### Step 4.5: Update Sync Marker

Write the sync timestamp:
  echo "$(date +%s)" > .claude/memory/.last-sync

Write in both manual and auto-sync modes. Refuse to write through symlinks.
```

Note: the existing `$TMPDIR/conkeeper/synced-$session_id` flag file is for within-session deduplication (preventing repeated sync nudges). `.last-sync` is for cross-session diffing. Both coexist.

### session-start.sh

After health check block:

1. Read `.claude/memory/.last-sync` content as epoch
   - If missing → skip (Feature 1 creates it on first run)
   - If symlink → skip
2. Git log since epoch: `git log --oneline --no-decorate --after="@<epoch>" -- . | head -10`
3. For each memory file, compare mtime against epoch:
   - mtime > epoch, file existed before → "modified"
   - mtime > epoch, file new → "added"
   - mtime <= epoch → omit
4. If no commits AND no file changes → output nothing
5. If changes detected, append to `additionalContext`:

```
<conkeeper-diff>
Since last sync (<N> commits):
  repo: abc1234 fix: auth validation | def5678 feat: add retry | ghi9012 docs: README
  memory: active-context.md modified, decisions/ADR-003.md added
Read the updated memory files listed above before proceeding with any task.
</conkeeper-diff>
```

- Git oneline: pipe-delimited, `--no-decorate`, `(+N more)` if >10
- Only changed/added files listed
- Directive ending tells agent to re-read before working

### Token Budget Gating

| Preset | Diff behavior |
|---|---|
| Economy (~2000) | Not shown |
| Light (~3000) | Max 3 commit onelines |
| Standard (~4000) | Max 5 commit onelines |
| Detailed (~6000) | Max 10 commit onelines |

### Edge Cases

- `.last-sync` missing → skip silently
- No git repo → skip repo line, still show memory file changes
- 0 commits + 0 memory changes → output nothing
- `.last-sync` is symlink → refuse to read

### Multi-Agent

Multiple agents sharing a project overwrite `.last-sync` on each sync. Agent B sees diff relative to Agent A's last sync. Acceptable for v1.2.0. Per-agent markers deferred to v1.3.0.

---

## Feature 5: Decision Index

Auto-generated lookup table of all ADRs. Agent instructions at top enforce lookup behavior over enumeration.

### Generated File: `decisions/INDEX.md`

```markdown
# Decision Index
<!-- Auto-generated by /memory-sync. Do not edit manually. -->

## Usage Instructions for Agents
- Use this index as a LOOKUP TABLE — do not read every ADR file
- Search the Title or Tags columns to find relevant decisions
- Only read the specific ADR file when you need full rationale
- Only Active decisions apply to current work
- If an ADR lists a Superseded By value, follow the chain to the current decision

| # | Title | Status | Date | Tags | Superseded By |
|---|-------|--------|------|------|---------------|
| ADR-001 | Pre-Compaction Context Preservation | Active | 2026-02-06 | hooks, context | — |
| ADR-002 | License: Apache 2.0 + Commons Clause | Active | 2026-02-06 | license, legal | — |
```

### `/memory-sync` SKILL.md (Step 4.6)

After writing `.last-sync`:

```
### Step 4.6: Generate Decision Index

If decisions/ directory exists and contains ADR files:

1. Scan decisions/*.md (exclude INDEX.md)
2. For each ADR, parse:
   - Title from header: # ADR-NNN: Title
   - Status, Date, Tags from metadata line: **Status:** X | **Date:** Y | **Tags:** Z
   - Superseded By from body (if present)
3. Skip ADRs with private: true in YAML frontmatter
4. Generate decisions/INDEX.md
5. If parsing fails for an ADR, include with title "[Parse error — read directly]"

This is agent-executed (skill, not bash). The agent parses markdown directly,
which handles edge cases more robustly than awk/sed.
```

### ADR Template Update

`core/memory/templates/adr-template.md`:

```markdown
---
private: false
---
# ADR-NNN: [Title]

**Status:** Accepted | **Date:** [date] | **Tags:** [tags]

## Context
[Why this decision was needed]

## Decision
[What was decided]

## Rationale
- [Key reason 1]
- [Key reason 2]

## Consequences
- [Consequence 1]
- [Consequence 2]

## Alternatives Considered
- [Alt 1]: [Why rejected]

## Superseded By
<!-- If replaced, reference the newer ADR: ADR-NNN -->
None
```

YAML frontmatter is optional — existing ADRs without it work fine. `private` defaults to false. `Superseded By` section is optional — absent means active.

### session-start.sh

Add to `additionalContext` (always present, ~20 tokens):

```
A decision index is available at decisions/INDEX.md. Use it as a lookup table — do not read every ADR file.
```

### Token Budget Gating

| Preset | INDEX.md behavior |
|---|---|
| Economy (~2000) | Not loaded (directive still injected, ~20 tokens) |
| Light (~3000) | Loaded if ≤10 entries |
| Standard (~4000) | Loaded |
| Detailed (~6000) | Loaded |

---

## Token Budget Summary

Additional tokens at session start:

| Feature | Economy | Light | Standard | Detailed |
|---|---|---|---|---|
| Health advisory (stale only) | ~50 | ~50 | ~50 | ~50 |
| Decision index directive | ~20 | ~20 | ~20 | ~20 |
| INDEX.md content | — | ~200 | ~300 | ~500 |
| Diff output | — | ~100 | ~200 | ~400 |
| friction.md content | — | ~200 | ~400 | ~800 |
| **Total additional** | **~70** | **~570** | **~970** | **~1770** |

---

## Implementation Plan

### Phase Order

```
Phase A: .last-sync marker + Memory Diff       (foundation)
Phase B: Memory Health Scoring                  (uses .last-sync)
Phase C: Decision Index                         (independent after A)
Phase D: Cross-Project Search                   (independent after A)
Phase E: Friction-Aware                         (independent after A)
```

A → B sequential. C, D, E parallelizable after B. Integration testing after parallel work (C, D, E all touch `session-start.sh` and/or `/memory-sync`).

### Modified Files

| File | Phases | Changes |
|---|---|---|
| `hooks/session-start.sh` | A, B | Health check, diff block, decision index directive, token budget gating, first-run .last-sync creation |
| `hooks/stop.sh` | B | Consolidated stale/reflect message from cached health |
| `tools/memory-search.sh` | D | `--cross-project` flag, path config, symlink validation |
| `skills/memory-sync/SKILL.md` | A, C | Step 4.5 (.last-sync), Step 4.6 (INDEX.md) |
| `skills/memory-insights/SKILL.md` | E | Insight routing to friction.md |
| `skills/memory-reflect/SKILL.md` | E | Friction cross-reference check |
| `skills/memory-init/SKILL.md` | D, E | Cross-project prompt (Step 4.5), create friction.md (Step 3) |
| `skills/memory-config/SKILL.md` | B, D | Document staleness_commits, project_search_paths |
| `core/memory/schema.md` | All | Document friction.md, INDEX.md, .last-sync, new config keys |
| `core/memory/templates/adr-template.md` | C | Optional YAML frontmatter, Superseded By section |

### New Files

| File | Phase | Purpose |
|---|---|---|
| `.claude/memory/friction.md` | E | Friction conventions (created at init) |
| `.claude/memory/decisions/INDEX.md` | C | Generated decision lookup table |
| `.claude/memory/.last-sync` | A | Unix epoch sync marker |

### New Config Keys

| Key | Default | Phase |
|---|---|---|
| `staleness_commits` | 5 (0 = disable) | B |
| `project_search_paths` | absent = off | D |

### Platform Adapter Updates

| Platform | Change |
|---|---|
| Copilot | memory-search skill: add `--cross-project` flag |
| Cursor | memory-search skill: add `--cross-project` flag |
| Codex | memory-search skill: add `--cross-project` flag |
| Windsurf | .windsurfrules: add cross-project search reference |
| Zed | memory-search rules-library: add `--cross-project` flag |

### Tests

| File | Coverage |
|---|---|
| `tests/phase-10-health/test-health.sh` | Staleness detection, first-run behavior, performance guard, cache, stop hook |
| `tests/phase-11-diff/test-diff.sh` | .last-sync creation/reading, diff detection, edge cases (no git, symlink, no changes) |
| `tests/phase-12-decisions/test-decisions.sh` | INDEX.md generation, header parsing, private ADR exclusion, parse errors |
| `tests/phase-13-cross-project/test-cross-project.sh` | Path validation, symlink security, flag stacking, privacy across projects, config states |
| `tests/phase-14-friction/test-friction.sh` | friction.md creation at init, insights routing, reflect cross-reference, entry cap |

---

## Deferred to v1.3.0

- **Friction lifecycle (New/Repeat/Resolved):** Automatic state tracking with matching algorithm, session count thresholds, pruning. Requires real-world usage data from v1.2.0.
- **Per-agent .last-sync markers:** For team workflow compatibility. Requires session/agent identity tracking.
- **Hybrid staleness metric:** Commits + calendar time. Evaluate after v1.2.0 usage.

## Deferred to Future (see `.claude/memory/future-enhancements.md`)

- Memory Decay / Staleness Flagging
- Skill Discovery (`/memory-discover`)
- MCP Tool Exposure
- Semantic Deduplication
- Open Questions Lifecycle
- Phase Metrics

---

*Design finalized 2026-02-14.*
