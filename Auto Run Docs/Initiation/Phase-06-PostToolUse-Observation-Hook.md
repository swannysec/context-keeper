# Phase 06: PostToolUse Observation Hook

**Agent Persona:** Hook Systems Developer — Focus on JSON parsing, performance (<100ms), append-only safety, Bash 3.2 compat.
**Version Bump:** v0.7.0 → v0.8.0
**Dependency:** Phase 04 (Privacy) for awareness of privacy patterns. Phase 05 (Search) so observations can be searched via `--sessions`. No blocking dependency — observations are consumed by Phase 07 (Corrections) and Phase 08 (Retrospection).
**Orchestration Reference:** See `Working/Agent-Orchestration-Plan.md` for review persona prompts and sub-agent dispatch instructions.

This phase adds a `PostToolUse` hook that logs tool usage to a per-session observations file. Two-tier logging: full entries for Bash/external tools, stub entries for native Read/Write/Edit tools. Creates a real-time activity log for agent analysis and `/memory-reflect`.

## Tasks

- [x] Create the PostToolUse hook script (`hooks/post-tool-use.sh`):
  - Create `hooks/post-tool-use.sh` with `#!/usr/bin/env bash` and `set -euo pipefail`
  - Add error trap matching existing hook pattern: `trap 'echo "[ConKeeper] post-tool-use.sh failed at line $LINENO" >&2; exit 0' ERR`
  - **Input parsing:** Read JSON from stdin (Claude Code PostToolUse hook provides):
    ```bash
    input=$(cat)
    tool_name=$(printf '%s' "$input" | jq -r '.tool_name // empty')
    tool_input=$(printf '%s' "$input" | jq -r '.tool_input // empty')
    session_id=$(printf '%s' "$input" | jq -r '.session_id // empty')
    cwd=$(printf '%s' "$input" | jq -r '.cwd // empty')
    ```
    Note: If jq is not available, exit 0 gracefully (same pattern as `user-prompt-submit.sh` line 9-12)
  - **Session ID validation:** Reuse the same sanitization pattern from `user-prompt-submit.sh` line 27-29:
    ```bash
    if [[ -z "$session_id" ]] || ! [[ "$session_id" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        exit 0
    fi
    ```
  - **Configuration check:** Read `.memory-config.md` to check `observation_hook` setting:
    - Parse YAML front matter (reuse the same parsing pattern from `user-prompt-submit.sh` lines 80-119)
    - Check `observation_hook` value. If `false`, exit 0 immediately.
    - Check `observation_detail` value for tier control (default: `full`)
  - **Observation file path:** `.claude/memory/sessions/$(date +%Y-%m-%d)-observations.md`
    - Only write if `.claude/memory/` directory exists: `[[ -d "${cwd:-.}/.claude/memory" ]] || exit 0`
    - Create `sessions/` dir if needed: `mkdir -p "${cwd:-.}/.claude/memory/sessions"`
  - **File header creation:** If the observation file doesn't exist, create it with:
    ```markdown
    # Session Observations — YYYY-MM-DD
    <!-- Auto-generated by ConKeeper PostToolUse hook -->

    ```
  - **Entry classification — two tiers:**
    - **Full entries** (Bash, WebFetch, WebSearch, Task, and any tool not in the stub list):
      ```markdown
      - **HH:MM:SS** | `Bash` | execute | `/path/to/file` | `npm test` | success
      ```
    - **Stub entries** (Read, Write, Edit, Glob, Grep, MultiEdit, NotebookEdit):
      ```markdown
      - **HH:MM:SS** | `Read` | read | `/path/to/file` | — | success
      ```
    - When `observation_detail` is `stubs_only`: write stub entries for ALL tools
    - When `observation_detail` is `off`: exit 0 (same as `observation_hook: false`)
  - **Field extraction from tool_input:**
    - **Timestamp:** `$(date +%H:%M:%S)`
    - **Action type mapping:** Read/Glob/Grep→`read`, Write/Edit/MultiEdit/NotebookEdit→`write`, Bash→`execute`, WebFetch/WebSearch→`fetch`, Task→`delegate`
    - **File path:** Extract from tool_input JSON. For Bash: extract from `command` field. For Read/Write/Edit: extract from `file_path` field. For Glob: extract from `pattern` field. Use jq: `printf '%s' "$tool_input" | jq -r '.file_path // .path // .command // .pattern // "—"' | head -c 120`
    - **Command summary (full entries only):** First 80 characters of the Bash command: `printf '%s' "$tool_input" | jq -r '.command // "—"' | head -c 80`
    - **Success/failure:** Check for error indicators in tool output. Parse `tool_output` if available, otherwise default to `success`. Look for `"error"`, `"Error"`, non-zero exit codes.
    - **Error message (failures only):** First 120 characters of error text
  - **Append operation:** Use `>>` to append to the observation file. This is atomic for small writes.
  - **Performance:** Script must complete in <100ms. It's just JSON parsing + file append. Timeout is set to 5 seconds in hooks.json.
  - **Bash 3.2 compatibility:** No `mapfile`, no associative arrays, no `$EPOCHSECONDS`. Use `date +%H:%M:%S` for timestamps. Use case statements instead of associative arrays for action type mapping.
  - Make executable: `chmod +x hooks/post-tool-use.sh`

- [x] Register the PostToolUse hook in `hooks/hooks.json`:
  - Add a new `"PostToolUse"` entry to the `"hooks"` object, after the existing `"PreCompact"` entry:
    ```json
    "PostToolUse": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/post-tool-use.sh",
            "timeout": 5
          }
        ]
      }
    ]
    ```
  - Verify the JSON is valid after editing (no trailing commas, proper nesting)

- [x] Modify `hooks/session-start.sh` to create the observations file at session start:
  - After the existing memory directory detection (around line 43-46), add:
    ```bash
    # Create observations file for this session
    if [ "$has_project" = true ]; then
        obs_dir=".claude/memory/sessions"
        obs_file="$obs_dir/$(date +%Y-%m-%d)-observations.md"
        mkdir -p "$obs_dir"
        if [ ! -f "$obs_file" ]; then
            cat > "$obs_file" << 'OBSEOF'
    # Session Observations — $(date +%Y-%m-%d)
    <!-- Auto-generated by ConKeeper PostToolUse hook -->

    OBSEOF
        fi
    fi
    ```
  - Note: Use actual date command, not literal `$(date)` in the heredoc. Switch to a non-heredoc approach if needed for the date substitution:
    ```bash
    printf '# Session Observations — %s\n<!-- Auto-generated by ConKeeper PostToolUse hook -->\n\n' "$(date +%Y-%m-%d)" > "$obs_file"
    ```
  - **Important:** Do NOT inject the observations file content into the session-start context message. It grows too large and is too noisy. It is consumed on-demand by `/memory-reflect` and `/memory-search --sessions`.

- [x] Update `/memory-config` skill to document observation settings:
  - Edit `skills/memory-config/SKILL.md`
  - Add new configuration options documentation:
    ```
    ## Observation Hook Settings

    | Setting | Default | Options | Description |
    |---------|---------|---------|-------------|
    | `observation_hook` | `true` | `true`, `false` | Enable/disable PostToolUse observation logging |
    | `observation_detail` | `full` | `full`, `stubs_only`, `off` | Detail level for observation entries |

    - `full`: Full entries for Bash/external tools, stub entries for native tools
    - `stubs_only`: Stub entries for all tools (timestamp, tool, type, path, status only)
    - `off`: No observation logging (same as `observation_hook: false`)
    ```

- [x] Update `core/memory/schema.md` to document the observations file:
  - In the Directory Structure section, add the observations file to the sessions listing:
    ```
    └── sessions/            # Session summaries
        ├── YYYY-MM-DD-HHMM.md
        ├── YYYY-MM-DD-topic.md
        └── YYYY-MM-DD-observations.md  # Tool usage log (auto-generated)
    ```
  - Add a new `### sessions/YYYY-MM-DD-observations.md` section after the session template section:
    ```
    **Purpose:** Real-time tool usage log for a session. Auto-generated by the PostToolUse hook.
    Not loaded into context at session start (too large). Consumed on-demand by /memory-reflect
    and /memory-search --sessions.
    ```
  - Document the observation entry format (full and stub variants)
  - Add a note about cleanup: "Observation files grow during a session. Old observation files can be safely deleted. They are not required for memory continuity."

- [x] Update `.memory-config.md` schema in `core/memory/schema.md`:
  - Add the new configuration fields to the `.memory-config.md` example:
    ```yaml
    observation_hook: true          # Enable/disable PostToolUse observation logging
    observation_detail: full        # full | stubs_only | off
    ```

- [x] Write tests for the PostToolUse observation hook:
  - Create `tests/phase-06-observations/test-observations.sh`
  - **Setup:** Create a temporary directory with `.claude/memory/sessions/` structure and a mock `.memory-config.md`
  - **Test 1:** Feed valid PostToolUse JSON (Bash tool) to `post-tool-use.sh` via stdin. Verify a full entry is appended to the observations file.
  - **Test 2:** Feed valid PostToolUse JSON (Read tool) via stdin. Verify a stub entry is written.
  - **Test 3:** Feed JSON with `observation_hook: false` in config. Verify no entry is written.
  - **Test 4:** Feed JSON with `observation_detail: stubs_only`. Verify Bash tool gets a stub entry (not full).
  - **Test 5:** Verify the observations file header is created by session-start.sh when it runs.
  - **Test 6:** Verify observations are NOT included in session-start.sh context output (grep for "observations" in the JSON output — should not appear).
  - **Test 7:** Verify Bash 3.2 compatibility — no Bash 4+ features used (parse the script with `bash --norc --noprofile -n hooks/post-tool-use.sh`)
  - **Test 8:** Verify the hook exits cleanly (exit 0) when no `.claude/memory/` directory exists
  - **Test 9:** Verify file path extraction from various tool_input JSON formats (Read with file_path, Bash with command, Glob with pattern)
  - **Test 10:** Verify error/failure entries include truncated error message
  - **Cleanup:** Remove temporary test directories
  - All tests runnable via `bash tests/phase-06-observations/test-observations.sh`

- [x] Bump version to v0.8.0 and verify all existing tests pass:
  - Edit `plugin.json`: change version to `"0.8.0"`
  - Run Phase 03 tests (categories)
  - Run Phase 04 tests (privacy)
  - Run Phase 05 tests (search)
  - Run Phase 06 tests (observations)
  - Verify `hooks/hooks.json` is valid JSON
  - Verify `session-start.sh` still produces valid JSON output
  - Commit all changes with message: `feat: add PostToolUse observation hook for session logging (v0.8.0)`

## Review & Validation

Review stages use dedicated agent types. Agent fixes findings autonomously unless they would change design intent or functionality. All review summaries are written to `Auto Run Docs/Initiation/Working/review-logs/phase-06-review-summary.md`. See `Working/Agent-Orchestration-Plan.md` Section 3 for full review prompt templates.

- [x] Stage 1 — Run tests: Execute `bash tests/phase-06-observations/test-observations.sh` and all prior phase tests (03-05) for regression. All tests must pass. Fix any failures before proceeding.
  - ✅ Phase 03 (categories): 10/10 passed
  - ✅ Phase 04 (privacy): 13/13 passed
  - ✅ Phase 05 (search): 11/11 passed
  - ✅ Phase 06 (observations): 10/10 passed

- [x] Stage 2 — Parallel code and architecture review: Launch two sub-agents in parallel. Sub-Agent A: `subagent_type: "workflow-toolkit:code-reviewer"` — review `hooks/post-tool-use.sh` for correctness, Bash 3.2 compat (critical — new hook on hot path), JSON parsing robustness (malformed input, missing fields, jq absence), performance (<100ms), error handling (fail-open), entry format, config parsing, test coverage. Sub-Agent B: `subagent_type: "compound-engineering:review:architecture-strategist"` — review hook registration in `hooks/hooks.json` (valid JSON, no conflicts), session-start.sh modification safety, observation file growth implications, schema documentation, config option defaults and backward compat, whether observations are correctly excluded from session-start context. Both output findings as Critical/High/Medium/Low.

- [x] Stage 3 — Synthesize review findings: Read both outputs. Deduplicate. Create consolidated list. Write summary to review log.
  - Consolidated 1 Critical, 2 High, 5 Medium, 6 Low findings. Review log written to `Working/review-logs/phase-06-review-summary.md`.

- [x] Stage 4 — Fix code and architecture findings: Fix all Critical, High, and Medium findings autonomously (escalate if design-changing). Re-run all test suites (03-06) after fixes.
  - Fixed C1: Updated all test JSON to use native JSON objects for `tool_input` (matching production format)
  - Fixed H1: Fixed dead-code fallback for empty `tool_input` — now uses `[[ -z ]]` check instead of unreachable `||`
  - Fixed H2: Added .gitignore guidance and secrets warning to `core/memory/schema.md`
  - Fixed M1: Consolidated 4 jq invocations into 2 (eval with @sh for scalars, jq -c for tool_input object)
  - M2 (success hardcoded): No fix needed — PostToolUse only fires for success per Claude Code docs
  - M3 (YAML parser fragility): Acceptable for defined format — no fix
  - M4 (opt-out default): Design decision kept as-is per architecture recommendation
  - M5 (duplicated config): Acceptable at 2 instances — tracked for future extraction
  - All tests pass: Phase 03 (10/10), Phase 04 (13/13), Phase 05 (11/11), Phase 06 (10/10)

- [x] Stage 5 — Simplicity review: Launch one sub-agent: `subagent_type: "compound-engineering:review:code-simplicity-reviewer"` — review post-fix `hooks/post-tool-use.sh` for over-engineering in the entry classification, field extraction, and config parsing logic.
  - Should simplify: Merge two case statements into one (-8 lines)
  - Should simplify: Replace while-loop + parse_yaml_val with awk one-liner (-21 lines)
  - Acceptable: Field extraction jq fallback chain, overall structure, eval+jq @sh pattern

- [x] Stage 6 — Fix simplicity findings + test: Fix all "should apply" findings autonomously. Re-run all tests. Write simplicity summary to review log.
  - Applied: Merged two case statements into one (-8 lines, single traversal)
  - Applied: Replaced while-loop + parse_yaml_val function with awk one-liner + inline extraction (-21 lines)
  - Script reduced from 137 to 108 lines (22% reduction)
  - All tests pass: Phase 03 (10/10), Phase 04 (13/13), Phase 05 (11/11), Phase 06 (10/10)

- [x] Stage 7 — Parallel security review (BLOCKED until Stage 6 complete and tests pass): Launch two sub-agents in parallel. CRITICAL: Do NOT start until Stage 6 is fully complete. Sub-Agent C: `subagent_type: "compound-engineering:review:security-sentinel"` (architecture focus) — review the PostToolUse hook's trust model (tool_name, tool_input, tool_output may contain malicious content), data flow from tool output to observation file (sensitive data leakage?), privacy enforcement (observations must never contain file content, only paths and metadata), fail-open safety. Sub-Agent D: `subagent_type: "compound-engineering:review:security-sentinel"` (technical focus) — review for command injection via tool_input/tool_output flowing into observation file (sanitization?), path traversal via crafted session_id or cwd, jq injection via malformed JSON, race conditions in concurrent file appends, symlink attacks on observation file, 5-second timeout enforcement. Data leakage and injection findings are Critical by default.

- [x] Stage 8 — Synthesize security findings: Read both outputs. Deduplicate. Create consolidated list. Write security summary to review log.
  - Both agents converged on: eval+@sh (Critical→Low after testing), symlink attack (Medium, confirmed), cwd validation (Medium, confirmed), sensitive data leakage (High, already documented in Stage 4)

- [x] Stage 9 — Fix security findings: Fix all Critical, High, and Medium findings autonomously (escalate if design-changing). Add security tests.
  - Removed `eval` + `@sh` pattern — reverted to separate jq calls (eliminates shell injection risk)
  - Added cwd path resolution via `cd && pwd` (prevents path traversal via crafted cwd)
  - Added symlink check `[[ -L "$obs_file" ]] && exit 0` (blocks symlink attack on observation file)
  - Replaced all `${cwd:-.}` with resolved `$cwd`
  - Added Test 11: symlink attack blocked
  - Added Test 12: path traversal session_id rejected
  - All 12 tests pass

- [x] Stage 10 — Final verification: Run all test suites (phases 03-06). All must pass. Verify `hooks/hooks.json` is valid JSON. Verify `session-start.sh` produces valid JSON. Verify `plugin.json` version is `"0.8.0"`. Write final status to review log. Commit any remaining fixes.
  - ✅ Phase 03 (categories): 10/10 passed
  - ✅ Phase 04 (privacy): 13/13 passed
  - ✅ Phase 05 (search): 11/11 passed
  - ✅ Phase 06 (observations): 12/12 passed
  - ✅ hooks.json: valid JSON
  - ✅ session-start.sh: valid JSON output
  - ✅ plugin.json: version 0.8.0
